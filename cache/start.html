
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
	<title>缓存JS和图片</title>
	<style type="text/css">
	span:empty::before {
		content: '缺省';
		color: gray;
	}
	</style>
</head>
<body>
<p><img src="./static/mm1.jpg" alt="示意图片" width="256" height="192"></p>
<h3>一些提示信息</h3>
<ul>
	<li>浏览器是否支持：<span id="isSupport"></span></li>
	<li>service worker是否注册成功：<span id="isSuccess"></span></li>
	<li>当前注册状态：<span id="state"></span></li>
	<li>当前service worker状态：<span id="swState"></span></li>
</ul>

<script src="./static/jquery.min.js"></script>
<script>
let db
// 参数1位数据库名，参数2为版本号
const request = window.indexedDB.open("xiaoceDB", 1)
// 使用IndexDB失败时的监听函数
request.onerror = function(event) {
		console.log('无法使用IndexDB')
	}
// 成功
request.onsuccess  = function(event){
	// 此处就可以获取到db实例
	db = event.target.result
	console.log("你打开了IndexDB")
}

request.onupgradeneeded = function(event){
  let objectStore
  // 如果同名表未被创建过，则新建test表
  if (!db.objectStoreNames.contains('test')) {
    objectStore = db.createObjectStore('test', { keyPath: 'id' })
  }
}

const transaction = db.transaction(["test"],"readwrite")
// 拿到Object Store对象
const objectStore = transaction.objectStore("test")
// 向表格写入数据
objectStore.add({id: 1, name: 'xiuyan'})

// 操作成功时的监听函数
transaction.oncomplete = function(event) {
	console.log("操作成功")
}
// 操作失败时的监听函数
transaction.onerror = function(event) {
	console.log("这里有一个Error")
}

if ('serviceWorker' in navigator) {
	$('#isSupport').text('支持');

	// 开始注册service workers
	navigator.serviceWorker.register('./sw-demo-cache.js', {
		scope: './'
	}).then(function (registration) {
		$('#isSuccess').text('注册成功');

        var serviceWorker;
        if (registration.installing) {
            serviceWorker = registration.installing;
            $('#state').text('installing');
        } else if (registration.waiting) {
            serviceWorker = registration.waiting;
            $('#state').text('waiting');
        } else if (registration.active) {
            serviceWorker = registration.active;
            $('#state').text('active');
        }
        if (serviceWorker) {
            $('#swState').text(serviceWorker.state);
            serviceWorker.addEventListener('statechange', function (e) {
            	$('#swState').append('&emsp;状态变化为' + e.target.state);
            });
        }
    }).catch (function (error) {
        $('#isSuccess').text('注册没有成功');
    });
} else {
	$('#isSupport').text('不支持');
}
</script>
</body>
</html>